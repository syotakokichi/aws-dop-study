# AWS CodePipeline

## 概要

AWS CodePipelineは、ソフトウェアのリリースプロセスを自動化するフルマネージドの継続的デリバリー（CD）サービス。コードの変更を検知し、ビルド、テスト、デプロイを自動的に実行するパイプラインを構築できる。

## キーコンセプト

- **パイプライン（Pipeline）**: ソフトウェアリリースプロセス全体を定義するワークフロー
- **ステージ（Stage）**: パイプライン内の論理的な区切り（例: Source, Build, Deploy）
- **アクション（Action）**: ステージ内で実行される個々のタスク
- **アーティファクト（Artifact）**: アクション間で受け渡されるファイル（S3に保存）
- **トランジション（Transition）**: ステージ間の移行（有効/無効を制御可能）
- **承認アクション（Approval Action）**: 手動承認を要求するアクション
- **並列アクション**: 同一ステージ内で複数アクションを並列実行
- **クロスアカウントデプロイ**: 異なるAWSアカウントへのデプロイ
- **クロスリージョンデプロイ**: 異なるリージョンへのデプロイ

## 試験頻出ポイント

- [ ] パイプライン構造（ステージ、アクション、アーティファクト）の理解
- [ ] ソースプロバイダーの種類と設定（CodeCommit, S3, GitHub, Bitbucket）
- [ ] 手動承認アクションの設定と通知（SNS連携）
- [ ] クロスアカウントデプロイの設定（IAMロール、KMS）
- [ ] クロスリージョンアクションの設定
- [ ] パイプライン実行の失敗時の挙動
- [ ] EventBridgeとの連携（パイプライン状態変更の検知）
- [ ] アーティファクトストア（S3バケット）の暗号化

## DOP-C02での出題パターン

### パターン1: マルチアカウント/マルチリージョンデプロイ
- **シナリオ**: 開発・ステージング・本番環境が異なるアカウントにある
- **ポイント**: クロスアカウントIAMロール、KMSキーポリシーの設定

### パターン2: 承認ワークフロー
- **シナリオ**: 本番デプロイ前に承認者の許可が必要
- **ポイント**: 手動承認アクション + SNS通知

### パターン3: パイプライン失敗時の対応
- **シナリオ**: デプロイ失敗時に自動ロールバック
- **ポイント**: CodeDeploy連携、CloudWatch Alarms

### パターン4: ソース変更の検知
- **シナリオ**: 特定ブランチの変更のみでパイプラインをトリガー
- **ポイント**: EventBridgeルール、ブランチフィルター

## ベストプラクティス

1. **最小権限の原則**: 各ステージに必要な権限のみ付与
2. **アーティファクトの暗号化**: AWS管理キーまたはCMKでS3バケットを暗号化
3. **手動承認の活用**: 本番環境へのデプロイ前に承認ステージを設置
4. **並列アクションの活用**: 独立したテストを並列実行して時間短縮
5. **失敗通知の設定**: SNSを使用してパイプライン失敗を即座に通知
6. **バージョン管理**: パイプライン定義をCloudFormation/CDKで管理

## 他サービスとの連携

| サービス | 連携内容 |
|----------|----------|
| CodeCommit | ソースプロバイダーとして使用 |
| CodeBuild | ビルド・テストアクション |
| CodeDeploy | デプロイアクション |
| S3 | ソース/アーティファクトストア |
| CloudFormation | IaCデプロイアクション |
| ECS | コンテナデプロイ |
| Lambda | カスタムアクション |
| SNS | 承認通知、失敗通知 |
| EventBridge | パイプラインイベントの検知 |
| IAM | クロスアカウントアクセス |
| KMS | アーティファクト暗号化 |

## 重要な設定項目

### クロスアカウントデプロイの設定

```
1. デプロイ先アカウントでIAMロールを作成
2. パイプラインアカウントのロールに対してAssumeRole許可
3. KMSキーポリシーでデプロイ先アカウントにDecrypt許可
4. S3バケットポリシーでデプロイ先アカウントにGetObject許可
```

### パイプライン実行モード

| モード | 説明 |
|--------|------|
| SUPERSEDED | 新しい実行が古い実行を置き換え（デフォルト） |
| QUEUED | 実行をキューイング |
| PARALLEL | 複数の実行を並列で処理 |

## ハンズオン記録

<!-- 実施後に記入 -->

## 参考リンク

- [AWS CodePipeline ユーザーガイド](https://docs.aws.amazon.com/codepipeline/latest/userguide/)
- [CodePipeline アクションタイプリファレンス](https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html)
- [クロスアカウントパイプラインの設定](https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-create-cross-account.html)
