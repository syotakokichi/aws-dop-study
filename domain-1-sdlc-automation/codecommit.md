# AWS CodeCommit

## 概要

AWS CodeCommitは、プライベートGitリポジトリをホストするフルマネージドのソースコード管理サービス。スケーラブルで安全なGitベースのリポジトリを提供し、既存のGitツールとシームレスに連携できる。

**重要**: 2024年7月より、新規顧客へのCodeCommit提供は終了。既存顧客は引き続き利用可能だが、試験では代替サービス（GitHub、GitLab等）への移行も考慮されることがある。

## キーコンセプト

- **リポジトリ**: Gitリポジトリ（コード、ブランチ、コミット履歴を格納）
- **ブランチ**: コードの分岐点（main, feature, develop等）
- **プルリクエスト**: コードレビューとマージのワークフロー
- **承認ルールテンプレート**: プルリクエストのマージ条件を定義
- **トリガー**: リポジトリイベントでLambda/SNSを起動
- **通知ルール**: リポジトリイベントをSNSに通知
- **クロスアカウントアクセス**: 他のAWSアカウントからのアクセス設定

## 試験頻出ポイント

- [ ] 認証方法（HTTPS Git認証情報、SSH鍵、IAM）
- [ ] プルリクエストと承認ルール
- [ ] トリガーと通知ルールの違い
- [ ] クロスアカウントアクセスの設定
- [ ] CodePipelineとの連携（変更検知方法）
- [ ] ブランチ保護とアクセス制御
- [ ] リポジトリのミラーリング/移行
- [ ] 暗号化（AWS管理キー、CMK）

## DOP-C02での出題パターン

### パターン1: 認証とアクセス制御
- **シナリオ**: 開発者ごとに特定ブランチへのプッシュ権限を制御
- **ポイント**: IAMポリシーでリソースレベルのアクセス制御

### パターン2: コードレビューワークフロー
- **シナリオ**: mainブランチへのマージには2人以上の承認が必要
- **ポイント**: 承認ルールテンプレートの設定

### パターン3: 自動化トリガー
- **シナリオ**: 特定ブランチへのプッシュでLambda関数を実行
- **ポイント**: トリガー設定、EventBridge連携

### パターン4: マルチアカウント開発
- **シナリオ**: 中央リポジトリを複数の開発アカウントで共有
- **ポイント**: クロスアカウントIAMロール、リソースベースポリシー

## ベストプラクティス

1. **ブランチ戦略の確立**: Git Flowまたはトランクベース開発
2. **承認ルールの設定**: 重要ブランチへのマージには承認を必須化
3. **IAMによるアクセス制御**: 最小権限の原則でリポジトリアクセスを管理
4. **通知の設定**: プルリクエスト作成時にチーム通知
5. **暗号化の確認**: リポジトリはデフォルトで暗号化（AWS管理キー）
6. **定期的なバックアップ**: git cloneでローカルバックアップ

## 認証方法

| 方法 | 説明 | ユースケース |
|------|------|--------------|
| HTTPS Git認証情報 | IAMユーザーに紐付くユーザー名/パスワード | 通常の開発者 |
| SSH鍵 | IAMユーザーに登録したSSH公開鍵 | SSHを好む開発者 |
| git-remote-codecommit | AWS CLIの認証情報を使用 | 一時認証情報、フェデレーション |
| IAMロール | EC2/CodeBuild等から直接アクセス | CI/CD環境 |

## トリガー vs 通知ルール

| 項目 | トリガー | 通知ルール |
|------|----------|------------|
| 対象 | Lambda、SNS | SNS（AWS Chatbot連携可） |
| イベント | プッシュ、ブランチ作成等 | PR、コメント、承認等含む広範囲 |
| カスタマイズ | ブランチフィルター可能 | 通知タイプで選択 |
| 設定場所 | リポジトリ設定 | 開発者用ツール設定 |

## 他サービスとの連携

| サービス | 連携内容 |
|----------|----------|
| CodePipeline | ソースステージとして統合 |
| CodeBuild | ソースプロバイダーとして使用 |
| Lambda | トリガーでカスタム処理 |
| SNS | 通知ルール/トリガーで通知 |
| EventBridge | リポジトリイベントの検知 |
| CloudTrail | API呼び出しの監査ログ |
| IAM | アクセス制御 |
| KMS | リポジトリの暗号化 |

## IAMポリシー例

### 特定ブランチへのプッシュ禁止

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": [
        "codecommit:GitPush",
        "codecommit:DeleteBranch",
        "codecommit:PutFile"
      ],
      "Resource": "arn:aws:codecommit:*:*:MyRepo",
      "Condition": {
        "StringEqualsIfExists": {
          "codecommit:References": [
            "refs/heads/main",
            "refs/heads/production"
          ]
        }
      }
    }
  ]
}
```

## ハンズオン記録

<!-- 実施後に記入 -->

## 参考リンク

- [AWS CodeCommit ユーザーガイド](https://docs.aws.amazon.com/codecommit/latest/userguide/)
- [CodeCommit の認証設定](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up.html)
- [承認ルールテンプレート](https://docs.aws.amazon.com/codecommit/latest/userguide/approval-rule-templates.html)
